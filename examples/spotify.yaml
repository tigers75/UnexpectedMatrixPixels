target:
  entity_id:
    - light.display_efd943
data:
  elements: |
    {% set elements = [] %}
    {% set t = now().timestamp() %} 
    {% set player = 'media_player.spotify' %}

    {# We use the variable 'player' defined in the blueprint variables #}
    {% set is_playing = is_state(player, 'playing') %} 

    {% if is_playing %}

      {# --- 1. SPOTIFY ICON (BACKGROUND) --- #}
      {% set elements = elements + [{
          "type": "icon",
          "name": "mdi:spotify",
          "x": 48,
          "y": -1,
          "size": 18,
          "color": [10, 255, 10, 105]
      }] %}
      
      {# --- 2. TEXT: ARTIST & TITLE --- #}
      {% set artist = state_attr(player, 'media_artist') | default('Unknown') %}
      {% set title = state_attr(player, 'media_title') | default('Track') %}

      {# Artist on Top #}
      {% set elements = elements + [{
          "type": "textlong",
          "content": artist,
          "x": 0,
          "y": 0,
          "font": "awtrix",
          "color": [200, 200, 200],
          "speed": 4.0,
          "scroll_duration": 1.5,
          "direction": "down"
      }] %}

      {# Title in Middle (y=6 leaves room for bar at bottom) #}
      {% set elements = elements + [{
          "type": "textlong",
          "content": title,
          "x": 0,
          "y": 6,
          "font": "awtrix",
          "color": [255, 255, 255],
          "speed": 4.0,
          "scroll_duration": 1.5,
          "direction": "up"
      }] %}

      {# --- 3. PROGRESS BAR (3px High) --- #}
      {# Occupies rows 13, 14, 15 #}
      
      {% set duration = state_attr(player, 'media_duration') | float(1) %}
      {% set position = state_attr(player, 'media_position') | float(0) %}
      {% set last_upd = as_timestamp(state_attr(player, 'media_position_updated_at')) | default(t) %}

      {% set calculated_pos = position + (t - last_upd) %}
      {% set current_pos = [calculated_pos, duration] | min %}
      
      {% set pct = current_pos / duration %}
      {% set bar_width = (pct * 64) | int %}

      {% set ns = namespace(pixels=[]) %}
      
      {% set color_fill = [10, 255, 10, 155] %}   {# Spotify Green #}
      {% set color_head = [255, 255, 255] %}     {# White Scrubber #}
      {% set color_track = [80, 80, 80, 155] %}  {# Dark Grey Background #}

      {# Loop X axis #}
      {% for x in range(0, 64) %}
          
          {# Determine Color based on progress #}
          {% if x < bar_width %}
              {% set col = color_fill %}
          {% elif x == bar_width %}
              {% set col = color_head %}
          {% else %}
              {% set col = color_track %}
          {% endif %}

          {# Draw 3 pixels vertical (Rows 13, 14, 15) #}
          {% for y in range(13, 16) %}
              {% set ns.pixels = ns.pixels + [[x, y] + col] %}
          {% endfor %}

      {% endfor %}

      {% set elements = elements + [{
          "type": "pixels",
          "pixels": ns.pixels
      }] %}

    {% endif %}
    {{ elements }}
  fps: 4
action: ump.draw_visuals

